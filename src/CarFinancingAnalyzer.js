import React, { useState, useEffect, useRef } from 'react';
import { jsPDF } from "jspdf";
import './CarFinancingAnalyzer.css';

// Constants and Data
const occupations = [
  'עורך דין', 'רופא', 'מהנדס', 'מורה', 'איש מכירות', 'אמן', 'מנהל פרויקטים',
  'יועץ פיננסי', 'פסיכולוג', 'יזם', 'שף', 'ספורטאי', 'מתכנת', 'מעצב גרפי', 'חשבונאי',
  'אדריכל', 'עיתונאי', 'טייס', 'שוטר', 'מוזיקאי', 'סטודנט', 'פנסיונר', 'עקרת בית',
  'מנכ"ל', 'פוליטיקאי', 'מדען', 'צלם', 'מאמן כושר', 'נהג מונית', 'מלצר',
  'ספר', 'נגר', 'אינסטלטור', 'חשמלאי', 'גנן', 'מורה דרך', 'וטרינר', 'אופטומטריסט',
  'פיזיותרפיסט', 'מתווך נדל"ן', 'ספורטאי מקצועי', 'שחקן', 'זמר', 'דוגמן', 'טבח',
  'ברמן', 'מאפר', 'קוסמטיקאית', 'מדריך כושר', 'מנהל מסעדה', 'יועץ ארגוני',
  'מהנדס תוכנה', 'מנהל מוצר', 'מעצב אופנה', 'כתב', 'עורך וידאו', 'מפיק',
  'שדרן רדיו', 'מנחה טלוויזיה', 'סוכן ביטוח'
];

const carTypes = ['משפחתי', 'יוקרה', 'ספורט', 'שטח', 'מיני', 'חשמלי', 'היברידי', 'מסחרי', 'קבריולט', 'ואן'];

const personalityTraits = {
  'עורך דין': ['אנליטי', 'מדויק', 'רהוט', 'אסרטיבי', 'אחראי'],
  'רופא': ['אמפתי', 'מסור', 'קפדני', 'סבלני', 'רגיש'],
  'מהנדס': ['לוגי', 'יצירתי', 'מדויק', 'אנליטי', 'פרקטי'],
  'מורה': ['סבלני', 'מסביר', 'אמפתי', 'יצירתי', 'מעורר השראה'],
  'איש מכירות': ['כריזמטי', 'משכנע', 'אנרגטי', 'אופטימי', 'חברותי'],
  'אמן': ['יצירתי', 'רגיש', 'אינטואיטיבי', 'מקורי', 'אקספרסיבי'],
  'מנהל פרויקטים': ['מאורגן', 'יעיל', 'מנהיג', 'אסטרטגי', 'גמיש'],
  'יועץ פיננסי': ['אנליטי', 'אחראי', 'אמין', 'מדויק', 'סבלני'],
  'פסיכולוג': ['אמפתי', 'מקשיב', 'אנליטי', 'סבלני', 'תומך'],
  'יזם': ['יצירתי', 'אמיץ', 'אופטימי', 'נחוש', 'גמיש'],
  'שף': ['יצירתי', 'קפדני', 'מדויק', 'תשוקתי', 'סבלני'],
  'ספורטאי': ['תחרותי', 'ממוקד', 'משמעת עצמית', 'אנרגטי', 'שאפתן'],
  'מתכנת': ['אנליטי', 'יצירתי', 'סבלני', 'פרפקציוניסט', 'לוגי'],
  'מעצב גרפי': ['יצירתי', 'חדשני', 'קשוב לפרטים', 'אסתטי', 'גמיש'],
  'חשבונאי': ['מדויק', 'אחראי', 'מאורגן', 'אנליטי', 'אמין'],
  'אדריכל': ['יצירתי', 'חזוני', 'פרקטי', 'קשוב לפרטים', 'אסתטי'],
  'עיתונאי': ['סקרן', 'אנליטי', 'תקשורתי', 'אובייקטיבי', 'נחוש'],
  'טייס': ['אחראי', 'קר רוח', 'מדויק', 'ממושמע', 'ערני'],
  'שוטר': ['אחראי', 'אמיץ', 'צודק', 'ערני', 'סמכותי'],
  'מוזיקאי': ['יצירתי', 'רגיש', 'מוכשר', 'תשוקתי', 'אקספרסיבי'],
  'סטודנט': ['סקרן', 'שאפתן', 'גמיש', 'מתמיד', 'פתוח לרעיונות'],
  'פנסיונר': ['חכם', 'סבלני', 'רגוע', 'מנוסה', 'אופטימי'],
  'עקרת בית': ['מסור', 'מאורגן', 'רב-משימתי', 'סבלני', 'יעיל'],
  'מנכ"ל': ['מנהיג', 'אסטרטגי', 'החלטי', 'כריזמטי', 'יוזם'],
  'פוליטיקאי': ['כריזמטי', 'משכנע', 'אסטרטגי', 'תקשורתי', 'אמביציוזי'],
  'מדען': ['סקרן', 'אנליטי', 'מדויק', 'יצירתי', 'ביקורתי'],
  'צלם': ['יצירתי', 'סבלני', 'קשוב לפרטים', 'אסתטי', 'טכני'],
  'מאמן כושר': ['מוטיבציוני', 'אנרגטי', 'סבלני', 'מסור', 'אופטימי'],
  'נהג מונית': ['סבלני', 'חברותי', 'זריז', 'אחראי', 'גמיש'],
  'מלצר': ['סבלני', 'חברותי', 'יעיל', 'קשוב', 'אנרגטי'],
  'ספר': ['יצירתי', 'חברותי', 'קשוב לפרטים', 'אסתטי', 'סבלני'],
  'נגר': ['מיומן', 'יצירתי', 'קפדני', 'סבלני', 'פרקטי'],
  'אינסטלטור': ['טכני', 'יעיל', 'אמין', 'פרקטי', 'פותר בעיות'],
  'חשמלאי': ['טכני', 'מדויק', 'בטיחותי', 'יעיל', 'פותר בעיות'],
  'גנן': ['יצירתי', 'סבלני', 'חובב טבע', 'מסור', 'פרקטי'],
  'מורה דרך': ['ידען', 'תקשורתי', 'סבלני', 'מארגן', 'חברותי'],
  'וטרינר': ['אוהב חיות', 'אמפתי', 'מקצועי', 'סבלני', 'רגיש'],
  'אופטומטריסט': ['מדויק', 'סבלני', 'תקשורתי', 'אמפתי', 'טכני'],
  'פיזיותרפיסט': ['סבלני', 'אמפתי', 'מקצועי', 'מוטיבציוני', 'קשוב'],
  'מתווך נדל"ן': ['תקשורתי', 'משכנע', 'יוזם', 'סבלני', 'אסטרטגי'],
  'ספורטאי מקצועי': ['תחרותי', 'ממושמע', 'שאפתן', 'מסור', 'חזק מנטלית'],
  'שחקן': ['אקספרסיבי', 'יצירתי', 'רגיש', 'גמיש', 'כריזמטי'],
  'זמר': ['מוכשר', 'אקספרסיבי', 'יצירתי', 'כריזמטי', 'רגיש'],
  'דוגמן': ['ביטחון עצמי', 'מקצועי', 'גמיש', 'סבלני', 'אסתטי'],
  'טבח': ['יצירתי', 'מדויק', 'יעיל', 'עמיד בלחץ', 'קפדני'],
  'ברמן': ['חברותי', 'יעיל', 'יצירתי', 'סבלני', 'רב-משימתי'],
  'מאפר': ['יצירתי', 'קשוב לפרטים', 'סבלני', 'תקשורתי', 'אסתטי'],
  'קוסמטיקאית': ['מקצועית', 'סבלנית', 'קשובה', 'אסתטית', 'חברותית'],
  'מדריך כושר': ['מוטיבציוני', 'אנרגטי', 'סבלני', 'מקצועי', 'תומך'],
  'מנהל מסעדה': ['מנהיג', 'יעיל', 'תקשורתי', 'פותר בעיות', 'רב-משימתי'],
  'יועץ ארגוני': ['אנליטי', 'תקשורתי', 'אסטרטגי', 'יצירתי', 'אמפתי'],
  'מהנדס תוכנה': ['אנליטי', 'יצירתי', 'פותר בעיות', 'לוגי', 'מדויק'],
  'מנהל מוצר': ['אסטרטגי', 'תקשורתי', 'יצירתי', 'אנליטי', 'מנהיג'],
  'מעצב אופנה': ['יצירתי', 'חדשני', 'אסתטי', 'קשוב לפרטים', 'מגמתי'],
  'כתב': ['סקרן', 'אנליטי', 'תקשורתי', 'יצירתי', 'אובייקטיבי'],
  'עורך וידאו': ['יצירתי', 'טכני', 'קשוב לפרטים', 'סבלני', 'אסתטי'],
  'מפיק': ['מנהיג', 'יצירתי', 'פותר בעיות', 'תקשורתי', 'רב-משימתי'],
  'שדרן רדיו': ['כריזמטי', 'תקשורתי', 'יצירתי', 'מהיר חשיבה', 'קול נעים'],
  'מנחה טלוויזיה': ['כריזמטי', 'תקשורתי', 'מקצועי', 'גמיש', 'רהוט'],
  'סוכן ביטוח': ['אמין', 'משכנע', 'אנליטי', 'סבלני', 'תקשורתי']
};

const carDatabase = {
  'משפחתי': {
    'חדש': [
      { name: 'סקודה אוקטביה', features: ['מרווחת', 'חסכונית', 'אמינה', 'בטיחותית', 'תא מטען גדול'] },
      { name: 'יונדאי i35', features: ['עיצוב מודרני', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'חסכונית בדלק', 'אחריות ארוכה'] },
      { name: 'קיה סיד', features: ['איכות בנייה גבוהה', 'מערכות בטיחות מתקדמות', 'נוחות נהיגה', 'עיצוב אירופאי', 'תמורה טובה למחיר'] },
      { name: 'טויוטה קורולה', features: ['אמינות גבוהה', 'ערך שוק גבוה', 'חסכונית בדלק', 'נוחות נסיעה', 'טכנולוגיה יפנית מתקדמת'] },
      { name: 'מאזדה 3', features: ['עיצוב ספורטיבי', 'חווית נהיגה מהנה', 'איכות גימור גבוהה', 'מערכות בטיחות מתקדמות', 'צריכת דלק נמוכה'] }
    ],
    'משומש': [
      { name: 'פורד פוקוס', features: ['אמינות', 'נוחות נהיגה', 'חלקי חילוף זולים', 'מרווחת', 'חסכונית בדלק'] },
      { name: 'הונדה סיוויק', features: ['אמינות גבוהה', 'ביצועים טובים', 'איכות בנייה', 'ערך שוק גבוה', 'חסכונית'] },
      { name: 'פיג\'ו 308', features: ['נוחות צרפתית', 'עיצוב אלגנטי', 'תא מטען גדול', 'צריכת דלק נמוכה', 'מערכות בטיחות'] },
      { name: 'סיאט לאון', features: ['מנועים חזקים', 'עיצוב ספורטיבי', 'טכנולוגיה גרמנית', 'חסכונית', 'נוחה לנהיגה'] },
      { name: 'אופל אסטרה', features: ['אמינות גרמנית', 'נוחות נסיעה', 'מרווחת', 'חסכונית בדלק', 'קלה לתחזוקה'] }
    ]
  },
  'יוקרה': {
    'חדש': [
      { name: 'מרצדס E-Class', features: ['יוקרה ונוחות', 'טכנולוגיה מתקדמת', 'ביצועים מרשימים', 'בטיחות ברמה גבוהה', 'סטטוס'] },
      { name: 'BMW סדרה 5', features: ['חווית נהיגה ספורטיבית', 'טכנולוגיה חדשנית', 'עיצוב יוקרתי', 'מנועים חזקים', 'נוחות מפנקת'] },
      { name: 'אאודי A6', features: ['עיצוב מודרני', 'טכנולוגיה מתקדמת', 'איכות בנייה גבוהה', 'נוחות נסיעה', 'ביצועים מרשימים'] },
      { name: 'לקסוס ES', features: ['אמינות יפנית', 'נוחות יוצאת דופן', 'שקט פנימי', 'חסכוני יחסית', 'ערך שוק גבוה'] },
      { name: 'וולוו S90', features: ['בטיחות ברמה הגבוהה ביותר', 'עיצוב סקנדינבי ייחודי', 'איכות פנים גבוהה', 'טכנולוגיה חדשנית', 'נוחות נסיעה'] }
    ],
    'משומש': [
      { name: 'ג\'גואר XF', features: ['יוקרה בריטית', 'ביצועים ספורטיביים', 'עיצוב ייחודי', 'נוחות נסיעה', 'טכנולוגיה מתקדמת'] },
      { name: 'אינפיניטי Q50', features: ['עיצוב יפני ייחודי', 'ביצועים חזקים', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'נדירות יחסית בכביש'] },
      { name: 'קאדילק CTS', features: ['יוקרה אמריקאית', 'מנועים חזקים', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'עיצוב בולט'] },
      { name: 'פורשה פאנאמרה', features: ['ביצועים ספורטיביים', 'יוקרה ברמה גבוהה', 'טכנולוגיה מתקדמת', 'עיצוב ייחודי', 'ארבע דלתות ומרווח'] },
      { name: 'מזראטי גיבלי', features: ['מנוע פרארי', 'עיצוב איטלקי מרהיב', 'סטטוס גבוה', 'ביצועים מרשימים', 'נדירות'] }
    ]
  },
  'ספורט': {
    'חדש': [
      { name: 'טויוטה סופרה', features: ['ביצועים מרשימים', 'עיצוב ספורטיבי', 'טכנולוגיה מתקדמת', 'חווית נהיגה מהנה', 'ערך שוק גבוה'] },
      { name: 'פורשה 911', features: ['ביצועים יוצאי דופן', 'מותג יוקרתי', 'עיצוב אייקוני', 'טכנולוגיה מתקדמת', 'ערך שוק גבוה'] },
      { name: 'שברולט קורבט', features: ['ביצועים אמריקאיים חזקים', 'עיצוב מרהיב', 'מחיר אטרקטיבי יחסית', 'טכנולוגיה מתקדמת', 'סאונד מנוע עוצמתי'] },
      { name: 'אאודי TT', features: ['עיצוב ייחודי', 'ביצועים טובים', 'איכות גרמנית', 'טכנולוגיה מתקדמת', 'נוחות יחסית לרכב ספורט'] },
      { name: 'BMW M2', features: ['ביצועים מרשימים', 'הנדסת BMW', 'עיצוב אגרסיבי', 'טכנולוגיה מתקדמת', 'חווית נהיגה ספורטיבית'] }
    ],
    'משומש': [
      { name: 'ניסאן GT-R', features: ['ביצועים על', 'טכנולוגיה יפנית מתקדמת', 'עיצוב ייחודי', 'אחיזת כביש מעולה', 'מהירות מרשימה'] },
      { name: 'פורד מוסטנג', features: ['מנוע V8 חזק', 'עיצוב אמריקאי קלאסי', 'סאונד מנוע עוצמתי', 'ביצועים טובים', 'מחיר אטרקטיבי'] },
      { name: 'מאזדה MX-5', features: ['חווית נהיגה מהנה', 'קלה ומהירה', 'גג נפתח', 'צריכת דלק נמוכה יחסית', 'אמינות יפנית'] },
      { name: 'סובארו BRZ', features: ['הנעה אחורית', 'קלה ומהנה לנהיגה', 'עיצוב ספורטיבי', 'מחיר אטרקטיבי', 'אמינות יפנית'] },
      { name: 'אלפא רומיאו 4C', features: ['עיצוב איטלקי מרהיב', 'קלה במיוחד', 'ביצועים מרשימים', 'נדירות', 'חווית נהיגה ייחודית'] }
    ]
  },
  'שטח': {
    'חדש': [
      { name: 'טויוטה לנד קרוזר', features: ['אמינות גבוהה', 'יכולות שטח מרשימות', 'נוחות גבוהה', 'ערך שוק גבוה', 'מרווח ומפנק'] },
      { name: 'ג\'יפ רנגלר', features: ['יכולות שטח מהטובות בעולם', 'עיצוב אייקוני', 'אפשרויות התאמה רבות', 'קהילת בעלים גדולה', 'ערך שוק גבוה'] },
      { name: 'לנד רובר דיפנדר', features: ['יכולות שטח מעולות', 'עיצוב בריטי ייחודי', 'טכנולוגיה מתקדמת', 'נוחות גבוהה', 'סטטוס גבוה'] },
      { name: 'פורד ברונקו', features: ['עיצוב רטרו מודרני', 'יכולות שטח טובות', 'טכנולוגיה מתקדמת', 'מחיר אטרקטיבי', 'אפשרויות התאמה רבות'] },
      { name: 'סוזוקי ג\'ימני', features: ['קומפקטי וזריז', 'יכולות שטח מפתיעות', 'צריכת דלק נמוכה', 'קל לתמרון בעיר', 'עיצוב ייחודי'] }
    ],
    'משומש': [
      { name: 'מיצובישי פאג\'רו', features: ['אמינות גבוהה', 'יכולות שטח טובות', 'נוח לשימוש יומיומי', 'ערך תמורה למחיר', 'תא מטען גדול'] },
      { name: 'ניסאן פטרול', features: ['אמינות גבוהה', 'מנוע חזק', 'יכולות שטח מצוינות', 'מרווח ונוח', 'פופולרי בקרב חובבי שטח'] },
      { name: 'טויוטה FJ קרוזר', features: ['עיצוב ייחודי', 'יכולות שטח מעולות', 'אמינות טויוטה', 'ערך שוק גבוה', 'פופולרי בקרב אספנים'] },
      { name: 'איסוזו D-Max', features: ['אמינות גבוהה', 'יכולות העמסה', 'מתאים לעבודה ופנאי', 'עלויות אחזקה נמוכות', 'יכולות גרירה'] },
      { name: 'סובארו אאוטבק', features: ['הנעה כפולה קבועה', 'נוחות נסיעה', 'מרווח גחון גבוה', 'אמינות יפנית', 'מתאים לשימוש יומיומי ולטיולים'] }
    ]
  },
  'מיני': {
    'חדש': [
      { name: 'קיה פיקנטו', features: ['חסכונית בדלק', 'קלה לתמרון בעיר', 'מחיר אטרקטיבי', 'אמינות קיה', 'עיצוב מודרני'] },
      { name: 'יונדאי i10', features: ['מרווחת יחסית לגודלה', 'טכנולוגיה מתקדמת', 'חסכונית', 'קלה לחניה', 'אחריות יצרן ארוכה'] },
      { name: 'סוזוקי סוויפט', features: ['הנאת נהיגה', 'עיצוב ספורטיבי', 'אמינות יפנית', 'חסכונית בדלק', 'קלה לתמרון'] },
      { name: 'פיאט 500', features: ['עיצוב רטרו אייקוני', 'קלה לחניה', 'מגוון אפשרויות התאמה אישית', 'חסכונית', 'אופי איטלקי'] },
      { name: 'מיני קופר', features: ['הנאת נהיגה', 'עיצוב בריטי אייקוני', 'איכות גבוהה', 'ערך שוק גבוה', 'מותג יוקרתי'] }
    ],
    'משומש': [
      { name: 'טויוטה יאריס', features: ['אמינות גבוהה', 'חסכונית בדלק', 'עלויות אחזקה נמוכות', 'קלה לתמרון', 'ערך שוק גבוה'] },
      { name: 'סיטרואן C1', features: ['עיצוב צרפתי ייחודי', 'חסכונית מאוד', 'קלה לחניה', 'מחיר נמוך', 'נוחה לנסיעה עירונית'] },
      { name: 'מאזדה 2', features: ['הנאת נהיגה', 'עיצוב דינמי', 'איכות גימור גבוהה', 'אמינות יפנית', 'חסכונית'] },
      { name: 'פורד פיאסטה', features: ['הנאת נהיגה', 'מנועים חזקים יחסית', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'פופולרית ואמינה'] },
      { name: 'סקודה סיטיגו', features: ['מרווחת יחסית לגודלה', 'איכות גרמנית', 'חסכונית בדלק', 'קלה לתמרון', 'מחיר אטרקטיבי'] }
    ]
  },
  'חשמלי': {
    'חדש': [
      { name: 'טסלה מודל 3', features: ['טווח נסיעה ארוך', 'ביצועים מרשימים', 'טכנולוגיה מתקדמת', 'מותג יוקרתי', 'עדכוני תוכנה שוטפים'] },
      { name: 'יונדאי איוניק 5', features: ['עיצוב עתידני', 'טעינה מהירה', 'מרווחת', 'טכנולוגיה מתקדמת', 'ביצועים טובים'] },
      { name: 'קיה EV6', features: ['טווח נסיעה ארוך', 'עיצוב ספורטיבי', 'ביצועים מרשימים', 'טעינה מהירה', 'טכנולוגיה מתקדמת'] },
      { name: 'פולקסווגן ID.4', features: ['מרווחת ופרקטית', 'איכות גרמנית', 'טווח נסיעה טוב', 'טכנולוגיה מתקדמת', 'נוחות נסיעה'] },
      { name: 'אאודי e-tron', features: ['איכות פרימיום', 'ביצועים מרשימים', 'טכנולוגיה מתקדמת', 'נוחות גבוהה', 'טעינה מהירה'] }
    ],
    'משומש': [
      { name: 'ניסאן ליף', features: ['אמינות גבוהה', 'עלויות אחזקה נמוכות', 'קלה לתפעול', 'מחיר אטרקטיבי', 'מתאימה לנסיעות עירוניות'] },
      { name: 'רנו זואי', features: ['טווח נסיעה טוב', 'קומפקטית וקלה לחניה', 'עלויות אחזקה נמוכות', 'נוחה לנהיגה עירונית', 'עיצוב חמוד'] },
      { name: 'BMW i3', features: ['עיצוב ייחודי', 'איכות גבוהה', 'קלה לתמרון בעיר', 'ביצועים טובים', 'טכנולוגיה מתקדמת'] },
      { name: 'שברולט בולט', features: ['טווח נסיעה ארוך', 'מרווחת יחסית', 'ביצועים טובים', 'אמינות אמריקאית', 'מחיר אטרקטיבי'] },
      { name: 'יונדאי קונה חשמלית', features: ['טווח נסיעה טוב', 'עיצוב מודרני', 'ביצועים טובים', 'אמינות יונדאי', 'מתאימה למשפחות קטנות'] }
    ]
  },
  'היברידי': {
    'חדש': [
      { name: 'טויוטה פריוס', features: ['חסכונית מאוד בדלק', 'אמינות גבוהה', 'טכנולוגיה היברידית מוכחת', 'ערך שוק גבוה', 'נוחה לנסיעות ארוכות'] },
      { name: 'הונדה CR-V היברידי', features: ['מרווחת ופרקטית', 'צריכת דלק נמוכה', 'נוחות נסיעה', 'אמינות הונדה', 'מתאימה למשפחות'] },
      { name: 'לקסוס NX היברידי', features: ['יוקרה יפנית', 'חסכוני בדלק', 'עיצוב מודרני', 'טכנולוגיה מתקדמת', 'נוחות גבוהה'] },
      { name: 'פורד קוגה היברידי', features: ['מרווחת', 'ביצועים טובים', 'טכנולוגיה מתקדמת', 'צריכת דלק נמוכה', 'מתאימה למשפחות'] },
      { name: 'יונדאי סונטה היברידי', features: ['עיצוב מרשים', 'חסכונית בדלק', 'מרווחת', 'טכנולוגיה מתקדמת', 'ביצועים טובים'] }
    ],
    'משומש': [
      { name: 'טויוטה יאריס היברידית', features: ['חסכונית מאוד', 'אמינות גבוהה', 'קלה לתמרון בעיר', 'עלויות אחזקה נמוכות', 'ערך שוק גבוה'] },
      { name: 'קיה נירו', features: ['מרווחת יחסית', 'צריכת דלק נמוכה', 'עיצוב מודרני', 'טכנולוגיה מתקדמת', 'אמינות קיה'] },
      { name: 'הונדה ג\'אז היברידית', features: ['חסכונית', 'מרווחת למרות גודלה הקטן', 'אמינות הונדה', 'קלה לתמרון', 'מתאימה לעיר'] },
      { name: 'לקסוס CT היברידי', features: ['יוקרה קומפקטית', 'צריכת דלק נמוכה', 'איכות גבוהה', 'עיצוב ספורטיבי', 'אמינות לקסוס'] },
      { name: 'מיצובישי אאוטלנדר היברידי', features: ['7 מקומות', 'צריכת דלק נמוכה יחסית לגודל', 'יכולות שטח קלות', 'מרווחת', 'אמינות יפנית'] }
    ]
  },
  'מסחרי': {
    'חדש': [
      { name: 'פורד טרנזיט', features: ['נפח העמסה גדול', 'אמינות גבוהה', 'נוחות נהיגה', 'מגוון תצורות', 'חסכוני יחסית'] },
      { name: 'פולקסווגן קראפטר', features: ['איכות גרמנית', 'מרווח פנים גדול', 'טכנולוגיה מתקדמת', 'נוחות נהיגה', 'בטיחות גבוהה'] },
      { name: 'מרצדס ספרינטר', features: ['יוקרה מסחרית', 'אמינות גבוהה', 'טכנולוגיה מתקדמת', 'מגוון תצורות', 'נוחות נהיגה'] },
      { name: 'פיאט דוקאטו', features: ['נפח העמסה גדול', 'חסכוני בדלק', 'קל יחסית לתמרון', 'מחיר אטרקטיבי', 'אמינות איטלקית'] },
      { name: 'איווקו דיילי', features: ['עמידות גבוהה', 'יכולת העמסה גבוהה', 'מנועים חזקים', 'מתאים למשימות קשות', 'מגוון תצורות'] }
    ],
    'משומש': [
      { name: 'רנו מאסטר', features: ['נפח העמסה גדול', 'אמינות טובה', 'נוחות נהיגה', 'חלקי חילוף זמינים', 'מחיר אטרקטיבי'] },
      { name: 'פיג\'ו בוקסר', features: ['חסכוני בדלק', 'נפח העמסה גדול', 'נוחות נהיגה', 'עיצוב מודרני', 'אמינות צרפתית'] },
      { name: 'ניסאן NV400', features: ['אמינות יפנית', 'נפח העמסה גדול', 'נוחות נהיגה', 'חסכוני בדלק', 'מחיר אטרקטיבי'] },
      { name: 'סיטרואן ג\'אמפי', features: ['עיצוב מודרני', 'נוחות נהיגה', 'חסכוני בדלק', 'טכנולוגיה מתקדמת יחסית', 'קל לתמרון'] },
      { name: 'טויוטה פרואייס', features: ['אמינות טויוטה', 'ערך שוק גבוה', 'נוחות נהיגה', 'חסכוני בדלק', 'טכנולוגיה יפנית'] }
    ]
  },
  'קבריולט': {
    'חדש': [
      { name: 'מאזדה MX-5', features: ['הנאת נהיגה', 'קלה ומהירה', 'עיצוב ספורטיבי', 'אמינות יפנית', 'חסכונית יחסית'] },
      { name: 'BMW סדרה 4 קבריולט', features: ['יוקרה גרמנית', 'ביצועים מרשימים', 'טכנולוגיה מתקדמת', 'נוחות גבוהה', 'עיצוב יוקרתי'] },
      { name: 'אאודי A5 קבריולט', features: ['איכות גבוהה', 'נוחות נסיעה', 'טכנולוגיה מתקדמת', 'עיצוב אלגנטי', 'ביצועים טובים'] },
      { name: 'פורשה 718 בוקסטר', features: ['ביצועים מעולים', 'הנדסה גרמנית', 'הנאת נהיגה', 'עיצוב ספורטיבי', 'ערך שוק גבוה'] },
      { name: 'מרצדס C-Class קבריולט', features: ['יוקרה ונוחות', 'טכנולוגיה מתקדמת', 'עיצוב אלגנטי', 'ביצועים טובים', 'מותג יוקרתי'] }
    ],
    'משומש': [
      { name: 'מיני קופר קבריולט', features: ['עיצוב אייקוני', 'הנאת נהיגה', 'קלה לתמרון בעיר', 'ערך שוק גבוה', 'מותג אופנתי'] },
      { name: 'פולקסווגן גולף קבריולט', features: ['אמינות גרמנית', 'נוחות נסיעה', 'מרווחת יחסית', 'חסכונית', 'קלה לתחזוקה'] },
      { name: 'פיאט 500C', features: ['עיצוב רטרו חמוד', 'קלה לחניה בעיר', 'חסכונית בדלק', 'מחיר אטרקטיבי', 'אופי איטלקי'] },
      { name: 'BMW Z4', features: ['ביצועים ספורטיביים', 'עיצוב מרשים', 'טכנולוגיה מתקדמת', 'הנאת נהיגה', 'ערך שוק גבוה'] },
      { name: 'אופל קסקדה', features: ['מרווחת יחסית', 'נוחות נסיעה', 'עיצוב אלגנטי', 'מחיר אטרקטיבי', 'חסכונית בדלק'] }
    ]
  },
  'ואן': {
    'חדש': [
      { name: 'פולקסווגן מולטיוואן', features: ['מרווח פנים גדול', 'נוחות נסיעה', 'טכנולוגיה מתקדמת', 'איכות גרמנית', 'גמישות פנימית'] },{ name: 'מרצדס V-Class', features: ['יוקרה ואיכות', 'מרווח מאוד', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'ביצועים טובים'] },
      { name: 'טויוטה פרואייס ורסו', features: ['אמינות טויוטה', '8 מקומות', 'חסכוני בדלק', 'נוחות נסיעה', 'ערך שוק גבוה'] },
      { name: 'פיאט טאלנטו', features: ['מרווח פנים גדול', 'עיצוב מודרני', 'נוחות נסיעה', 'חסכוני בדלק', 'מחיר אטרקטיבי'] },
      { name: 'פורד טורנאו קאסטום', features: ['מרווח ופרקטי', 'טכנולוגיה מתקדמת', 'נוחות נסיעה', 'ביצועים טובים', 'גמישות פנימית'] }
    ],
    'משומש': [
      { name: 'קיה קרניבל', features: ['מרווח מאוד', '7-8 מקומות', 'נוחות נסיעה', 'אמינות קיה', 'ערך טוב למחיר'] },
      { name: 'רנו טראפיק', features: ['מרווח פנים', 'חסכוני בדלק', 'נוחות נסיעה', 'קל יחסית לתמרון', 'מתאים למשפחות גדולות'] },
      { name: 'סיאט אלהמברה', features: ['7 מקומות', 'איכות פולקסווגן', 'נוחות נסיעה', 'חסכוני בדלק', 'קל לתחזוקה'] },
      { name: 'פיג\'ו טרוולר', features: ['מרווח פנים', 'נוחות נסיעה', 'עיצוב מודרני', 'חסכוני בדלק', 'טכנולוגיה טובה'] },
      { name: 'אופל ויוארו', features: ['מרווח ופרקטי', 'נוחות נסיעה', 'חסכוני בדלק', 'קל לתחזוקה', 'מתאים למשפחות גדולות'] }
    ]
  }
};

// Helper Functions
const getPersonalityTraits = (occupation) => {
  return personalityTraits[occupation] || ['גמיש', 'מסתגל', 'יעיל', 'מקצועי', 'אחראי'];
};

const getRecommendedCars = (carType, isNew, personalityTraits) => {
  const condition = isNew ? 'חדש' : 'משומש';
  let cars = carDatabase[carType][condition];
  
  // Sort cars based on how well they match the personality traits
  cars.sort((a, b) => {
    const aScore = a.features.filter(feature => personalityTraits.includes(feature)).length;
    const bScore = b.features.filter(feature => personalityTraits.includes(feature)).length;
    return bScore - aScore;
  });

  return cars;
};

const generatePersonalizedOpening = (firstName, age, occupation) => {
  const openings = [
    `היי ${firstName}, תודה שפנית אלינו. אני מבין שאתה מחפש רכב שיתאים לצרכים הייחודיים שלך.`,
    `שלום ${firstName}, נעים להכיר! אני כאן כדי לעזור לך למצוא את הרכב המושלם עבורך.`,
    `ברוך הבא, ${firstName}! אני שמח שהגעת אלינו. בוא נמצא יחד את הרכב שיענה על כל הדרישות שלך.`,
    `היי ${firstName}, איזה כיף שפנית אלינו! אני בטוח שנוכל למצוא את הרכב המושלם שיתאים בדיוק לסגנון החיים שלך.`,
    `שלום ${firstName}! אני כאן כדי להקשיב לצרכים שלך ולהתאים לך את הרכב הטוב ביותר. בוא נתחיל!`
  ];

  return openings[Math.floor(Math.random() * openings.length)];
};

const generatePersonalizedCarDescription = (car, personalityTraits, occupation) => {
  const descriptions = [
    `ה${car.name} ידוע ב${car.features[0]} וב${car.features[1]} שלו. זה יכול להתאים מצוין ל${occupation} כמוך, במיוחד בהתחשב ב${personalityTraits[0]} שלך.`,
    `עבור מי שמחפש ${car.features[2]} ו${car.features[3]}, ה${car.name} יכול להיות בחירה מעולה. זה במיוחד נכון ל${occupation} שמעריך ${personalityTraits[1]}.`,
    `ה${car.name} משלב ${car.features[0]} עם ${car.features[4]}. זו יכולה להיות התאמה נהדרת למי שה${personalityTraits[2]} חשוב לו, כמו ${occupation} בתחומך.`,
    `אם אתה מחפש רכב שמציע ${car.features[1]} ו${car.features[3]}, ה${car.name} יכול להיות בדיוק מה שאתה צריך. זה במיוחד מתאים ל${occupation} עם גישה ${personalityTraits[3]}.`,
    `ה${car.name} ידוע בזכות ה${car.features[2]} וה${car.features[4]} שלו. אלו תכונות שיכולות להתאים מאוד ל${occupation} שמאופיין ב${personalityTraits[4]}.`
  ];

  return descriptions[Math.floor(Math.random() * descriptions.length)];
};

const generateFinancingBenefits = (firstName, personalityTraits) => {
  let benefits = `
  ${firstName}, אני רוצה להציג בפניך כמה אפשרויות מימון שיכולות להתאים לך:

  1. פריסת תשלומים גמישה: אנחנו מציעים פריסה של עד 100 תשלומים. `;
  
  if (personalityTraits.includes('אנליטי') || personalityTraits.includes('מדויק')) {
    benefits += `זה יאפשר לך לתכנן את התקציב שלך בצורה מדויקת ויעילה, תוך התחשבות בתזרים המזומנים שלך לטווח ארוך.`;
  } else if (personalityTraits.includes('יצירתי') || personalityTraits.includes('גמיש')) {
    benefits += `זה נותן לך את החופש להתאים את התשלומים לסגנון החיים שלך, עם אפשרות לשינויים לאורך הדרך.`;
  } else {
    benefits += `זה מאפשר לך ליהנות מהרכב תוך שמירה על תזרים מזומנים נוח, בהתאם לצרכים הספציפיים שלך.`;
  }

  benefits += `

  2. תקופת חסד בתחילת ההלוואה: אתה יכול לדחות את התשלום הראשון בעד 3 חודשים. `;
  
  if (personalityTraits.includes('שאפתן') || personalityTraits.includes('יזם')) {
    benefits += `זה יכול לתת לך זמן להשקיע בפרויקטים אחרים או בעסק שלך, ולהגדיל את ההכנסות לפני שמתחילים התשלומים.`;
  } else if (personalityTraits.includes('מעשי') || personalityTraits.includes('זהיר')) {
    benefits += `זה מאפשר לך להתארגן כלכלית ולתכנן את התקציב שלך בצורה מושכלת, תוך התחשבות בהוצאות הנלוות לרכישת רכב.`;
  } else {
    benefits += `זה נותן לך זמן להתרגל לרכב החדש ולהתארגן מבחינה כלכלית, בלי לחץ מיידי של תשלומים.`;
  }

  benefits += `

  3. אפשרות לפירעון מוקדם: אתה יכול לפרוע את ההלוואה בכל שלב. `;
  
  if (personalityTraits.includes('אנליטי') || personalityTraits.includes('אסטרטגי')) {
    benefits += `זה מאפשר לך לנצל הזדמנויות פיננסיות כשהן מגיעות ולחסוך בריבית, תוך אופטימיזציה של המצב הפיננסי שלך.`;
  } else if (personalityTraits.includes('גמיש') || personalityTraits.includes('ספונטני')) {
    benefits += `זה נותן לך את החופש לשנות את התוכניות שלך בהתאם להתפתחויות בחיים, בלי להיות כבול לתוכנית קבועה.`;
  } else {
    benefits += `זה מעניק לך שקט נפשי, כי אתה יודע שיש לך אפשרות לסיים את ההלוואה מתי שתרצה, בהתאם למצבך הכלכלי.`;
  }

  benefits += `

  4. ליווי אישי: הצוות שלנו ילווה אותך לאורך כל התהליך, מהבחירה ועד לאחר הרכישה. `;
  
  if (personalityTraits.includes('אמפתי') || personalityTraits.includes('חברותי')) {
    benefits += `אנחנו מאמינים ביצירת קשר אישי ובהבנת הצרכים הייחודיים של כל לקוח, ונשמח לבנות איתך מערכת יחסים ארוכת טווח.`;
  } else if (personalityTraits.includes('עצמאי') || personalityTraits.includes('ביקורתי')) {
    benefits += `אנחנו כאן לספק לך את כל המידע שתצטרך כדי לקבל החלטה מושכלת, תוך כיבוד העצמאות שלך בתהליך קבלת ההחלטות.`;
  } else {
    benefits += `זה מבטיח שתקבל את התמיכה והמידע הנחוצים בכל שלב בדרך, מההתלבטות הראשונית ועד לטיפולים השוטפים ברכב.`;
  }

  benefits += `

  5. תוכנית Trade-in: אם יש לך רכב ישן, אנחנו יכולים להציע לך עסקת החלפה אטרקטיבית. `;
  
  if (personalityTraits.includes('יעיל') || personalityTraits.includes('מעשי')) {
    benefits += `זה יכול לפשט את כל התהליך ולחסוך לך זמן וטרחה, תוך מקסום הערך של הרכב הנוכחי שלך.`;
  } else if (personalityTraits.includes('חדשני') || personalityTraits.includes('סקרן')) {
    benefits += `זו דרך מצוינת לשדרג את הרכב שלך לדגם חדש יותר עם טכנולוגיה מתקדמת, תוך ניצול הערך שנשאר ברכב הישן.`;
  } else {
    benefits += `זו אפשרות נהדרת להקל על המעבר לרכב החדש שלך, תוך הפחתת העלויות הכוללות של העסקה.`;
  }

  benefits += `

  ${firstName}, איך כל זה נשמע לך? האם יש אפשרות מימון ספציפית שמעניינת אותך במיוחד או שאתה רוצה לשמוע עוד פרטים לגביה?`;

  return benefits;
};

const generatePersonalizedClosing = (firstName, personalityTraits) => {
  const closings = [
    `${firstName}, לאור מה שדיברנו, אני חושב שיש לנו כאן כמה אפשרויות מעולות עבורך. מה דעתך שניפגש ונדבר על זה יותר לעומק?`,
    `תודה שהקדשת מזמנך, ${firstName}. אני מרגיש שיש לנו כאן התאמה טובה. אשמח אם נוכל לקבוע פגישה ולהמשיך את השיחה פנים מול פנים.`,
    `${firstName}, נראה שיש לנו כמה אפשרויות מעניינות לבחון. אולי כדאי שנקבע זמן לפגישה בסוכנות? ככה תוכל לראות ולהרגיש את הרכבים בעצמך.`,
    `אני מאמין שמצאנו כמה אפשרויות שיכולות להתאים לך בול, ${firstName}. מה דעתך לקפוץ אלינו לסוכנות ולהמשיך את השיחה שם?`,
    `${firstName}, אחרי השיחה הזו, אני מרגיש שאנחנו בכיוון הנכון. בוא נקבע פגישה בסוכנות, שם נוכל לדבר יותר לעומק ולבחון את האפשרויות מקרוב.`
  ];

  return closings[Math.floor(Math.random() * closings.length)];
};

const generateScript = (firstName, lastName, age, occupation, carType, isNew) => {
  const personalityTraits = getPersonalityTraits(occupation);
  const recommendedCars = getRecommendedCars(carType, isNew, personalityTraits);
  const carCondition = isNew ? 'חדש' : 'משומש באיכות גבוהה';

  const opening = generatePersonalizedOpening(firstName, age, occupation);
  const mainCar = recommendedCars[0];
  const otherCars = recommendedCars.slice(1, 5);

  let script = `
  ${opening}

  ${firstName}, בהתחשב במה שסיפרת לי על עיסוקך כ${occupation} והצרכים שלך, אני חושב שה${mainCar.name} ${carCondition} יכול להיות התאמה מעולה עבורך.
  ${generatePersonalizedCarDescription(mainCar, personalityTraits, occupation)}

  כמובן, יש לנו גם אפשרויות נוספות שיכולות להתאים לך. הנה כמה מהן:

  ${otherCars.map((car, index) => `
  ${index + 1}. ${car.name}: ${generatePersonalizedCarDescription(car, personalityTraits, occupation)}
  `).join('')}

  ${generateFinancingBenefits(firstName, personalityTraits)}

  ${generatePersonalizedClosing(firstName, personalityTraits)}

  אם זה נשמע לך טוב, אני יכול לתאם לך פגישה עם אחד המומחים שלנו עוד היום. יש לנו זמן פנוי ב-14:00 או ב-16:30. מה יותר נוח לך, ${firstName}?

  אני כאן לכל שאלה או התלבטות. המטרה שלי היא לעזור לך למצוא את הרכב המושלם, בתנאים שמתאימים בדיוק לך.
  `;

  return script;
};

const CarFinancingConversationAnalyzer = () => {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');
  const [birthdate, setBirthdate] = useState('');
  const [age, setAge] = useState('');
  const [occupation, setOccupation] = useState('');
  const [carType, setCarType] = useState('');
  const [isNew, setIsNew] = useState(true);
  const [analysis, setAnalysis] = useState(null);
  const [expandedCar, setExpandedCar] = useState(null);

  const occupationInputRef = useRef(null);

  useEffect(() => {
    if (birthdate) {
      const today = new Date();
      const birth = new Date(birthdate);
      let calculatedAge = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        calculatedAge--;
      }
      setAge(calculatedAge.toString());
    }
  }, [birthdate]);

  const handleOccupationChange = (e) => {
    const value = e.target.value;
    setOccupation(value);
    
    if (value.length > 0) {
      const matchingOccupations = occupations.filter(occ => 
        occ.startsWith(value) && occ !== value
      );
      
      if (matchingOccupations.length > 0) {
        occupationInputRef.current.setAttribute('list', 'occupationList');
      } else {
        occupationInputRef.current.removeAttribute('list');
      }
    } else {
      occupationInputRef.current.removeAttribute('list');
    }
  };

  const analyzeAndCreateScript = () => {
    if (!firstName || !lastName || !occupation || !carType) {
      alert('נא למלא את כל השדות החובה (שם פרטי, שם משפחה, מקצוע וסוג רכב)');
      return;
    }

    if (birthdate) {
      const calculatedAge = parseInt(age);
      if (calculatedAge < 18 || calculatedAge > 80) {
        alert('גיל חייב להיות בין 18 ל-80');
        return;
      }
    }

    const script = generateScript(firstName, lastName, parseInt(age) || 30, occupation, carType, isNew);
    
    const personalityTraits = getPersonalityTraits(occupation);
    const recommendedCars = getRecommendedCars(carType, isNew, personalityTraits);
    
    setAnalysis({ 
      conversationScript: script,
      mainCar: recommendedCars[0],
      otherCars: recommendedCars.slice(1, 5)
    });
  };

  const resetForm = () => {
    setFirstName('');
    setLastName('');
    setBirthdate('');
    setAge('');
    setOccupation('');
    setCarType('');
    setIsNew(true);
    setAnalysis(null);
    setExpandedCar(null);
  };

  const saveToPDF = () => {
    const doc = new jsPDF({
      orientation: 'p',
      unit: 'mm',
      format: 'a4',
      putOnlyUsedFonts: true
    });

    doc.addFont("assets/fonts/Arial.ttf", "Arial", "normal");
    doc.setFont("Arial");
    doc.setFontSize(12);
    doc.setR2L(true);
    
    const splitText = doc.splitTextToSize(analysis.conversationScript, 180);
    doc.text(splitText, 190, 10, { align: 'right' });
    
    doc.save("car_financing_script.pdf");
  };

  const toggleCarDetails = (carName) => {
    setExpandedCar(expandedCar === carName ? null : carName);
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      analyzeAndCreateScript();
    }
  };

  return (
    <div className="analyzer-container">
      <h1>מנתח שיחת מימון ומכירת רכב מתקדם</h1>
      <div className="input-group">
        <input 
          type="text" 
          placeholder="שם פרטי" 
          value={firstName} 
          onChange={(e) => setFirstName(e.target.value)}
          onKeyPress={handleKeyPress}
        />
        <input 
          type="text" 
          placeholder="שם משפחה" 
          value={lastName} 
          onChange={(e) => setLastName(e.target.value)}
          onKeyPress={handleKeyPress}
        />
        <input 
          type="date" 
          placeholder="תאריך לידה" 
          value={birthdate} 
          onChange={(e) => setBirthdate(e.target.value)}
          onKeyPress={handleKeyPress}
          min={new Date(new Date().setFullYear(new Date().getFullYear() - 80)).toISOString().split('T')[0]}
          max={new Date(new Date().setFullYear(new Date().getFullYear() - 18)).toISOString().split('T')[0]}
        />
        <input 
          type="text" 
          placeholder="מקצוע" 
          value={occupation} 
          onChange={handleOccupationChange}
          onKeyPress={handleKeyPress}
          ref={occupationInputRef}
        />
        <datalist id="occupationList">
          {occupations.filter(occ => occ.startsWith(occupation) && occ !== occupation).map(occ => (
            <option key={occ} value={occ} />
          ))}
        </datalist>
        <select 
          value={carType} 
          onChange={(e) => setCarType(e.target.value)}
          onKeyPress={handleKeyPress}
        >
          <option value="">בחר סוג רכב</option>
          {carTypes.map(type => <option key={type} value={type}>{type}</option>)}
        </select>
        <div className="radio-group">
          <label>
            <input 
              type="radio" 
              value="new" 
              checked={isNew} 
              onChange={() => setIsNew(true)} 
            />
            רכב חדש
          </label>
          <label>
            <input 
              type="radio" 
              value="used" 
              checked={!isNew} 
              onChange={() => setIsNew(false)} 
            />
            רכב משומש
          </label>
        </div>
      </div>
      <button onClick={analyzeAndCreateScript}>צור תסריט שיחה מתקדם</button>
      {analysis && (
        <div className="analysis-result">
          <h3>תסריט שיחה מפורט:</h3>
          <pre>{analysis.conversationScript}</pre>
          <h3>רכבים מומלצים:</h3>
          <div className="car-recommendations">
            <div className="main-car">
              <h4>הרכב המומלץ ביותר:</h4>
              <p>{analysis.mainCar.name}</p>
              <ul>
                {analysis.mainCar.features.map((feature, idx) => (
                  <li key={idx}>{feature}</li>
                ))}
              </ul>
            </div>
            <div className="other-cars">
              <h4>אפשרויות נוספות:</h4>
              {analysis.otherCars.map((car, index) => (
                <div key={car.name} className="car-option">
                  <p onClick={() => toggleCarDetails(car.name)} style={{cursor: 'pointer'}}>
                    {car.name} {expandedCar === car.name ? '▼' : '►'}
                  </p>
                  {expandedCar === car.name && (
                    <ul>
                      {car.features.map((feature, idx) => (
                        <li key={idx}>{feature}</li>
                      ))}
                    </ul>
                  )}
                </div>
              ))}
            </div>
          </div>
          <button onClick={saveToPDF}>שמור כ-PDF</button>
          <button onClick={resetForm}>אפס טופס</button>
        </div>
      )}
    </div>
  );
};

export default CarFinancingConversationAnalyzer;